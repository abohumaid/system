<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج إدارة العملاء مع Firebase</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- إضافة Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js";

        // تكوين Firebase - استبدل بقيمك الخاصة
        const firebaseConfig = {
            apiKey: "AIzaSyDBkLtZxsqqzRRb5RNaiE82mReGtGTVXws",
            authDomain: "customer-mangement.firebaseapp.com",
            databaseURL: "https://customer-mangement-default-rtdb.firebaseio.com",
            projectId: "customer-mangement",
            storageBucket: "customer-mangement.appspot.com",
            messagingSenderId: "1069767016739",
            appId: "1:1069767016739:web:8eba049d9d8d6ea6f30c96",
            measurementId: "G-JG50T2CZ3Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // اجعل الدوال متاحة للاستخدام في الصفحة
        window.firebaseFunctions = {
            saveData: async (clientData) => {
                try {
                    await set(ref(database, 'clients/' + clientData.phone), clientData);
                    return true;
                } catch (error) {
                    console.error("Error saving data:", error);
                    return false;
                }
            },
            getClient: async (phone) => {
                try {
                    const snapshot = await get(ref(database, 'clients/' + phone));
                    return snapshot.val();
                } catch (error) {
                    console.error("Error getting client:", error);
                    return null;
                }
            },
            getAllClients: async () => {
                try {
                    const snapshot = await get(ref(database, 'clients'));
                    return snapshot.val() || {};
                } catch (error) {
                    console.error("Error getting all clients:", error);
                    return {};
                }
            },
            deleteClient: async (phone) => {
                try {
                    await remove(ref(database, 'clients/' + phone));
                    return true;
                } catch (error) {
                    console.error("Error deleting client:", error);
                    return false;
                }
            }
        };
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f2f2f2;
            color: #333;
            direction: rtl;
            padding: 20px;
        }
        h2, h3 {
            color: #006699;
        }
        label {
            margin: 10px 0;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px;
            margin-top: 5px;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 18px;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        th {
            background-color: #006699;
            color: white;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .fixed-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        .fixed-buttons button {
            flex: 1;
        }
        .sync-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .online {
            background-color: #d4edda;
            color: #155724;
        }
        .offline {
            background-color: #f8d7da;
            color: #721c24;
        }
        .syncing {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <h3>نظام إدارة العملاء - متزامن</h3>
    <div id="connectionStatus" class="sync-status offline">جاري التحقق من حالة الاتصال...</div>
    
    <h2>بيانات العميل</h2>
    <label>اسم العميل: <input type="text" id="name"></label>
    <label>رقم الهاتف: <input type="text" id="phone"></label><br>
    <label>رقم هاتف آخر: <input type="text" id="otherPhone"></label>
    <label>المحافظة: 
        <select id="governorate" onchange="updateRegions()">
            <option value="">اختر المحافظة</option>
            <option value="القاهرة">القاهرة</option>
            <option value="الجيزة">الجيزة</option>
        </select><br>
    </label>
    <label>المنطقة: 
        <select id="region">
            <option value="">اختر المنطقة</option>
        </select>
    </label>
    
    <div class="fixed-buttons">
        <button onclick="toggleInquiry()">استفسارات</button>
        <button onclick="toggleComplaint()">المشاكل</button>
    </div>
    
    <div id="inquirySection" class="hidden">
        <label>نوع الاستفسار:
            <select id="inquiryType" onchange="updateInquiryNames()">
                <option value="">اختر نوع الاستفسار</option>
                <option value="استفسار عام">استفسار عام</option>
                <option value="استفسار خاص">استفسار خاص</option>
            </select>
        </label>
        <label>اسم الاستفسار:
            <select id="inquiryName">
                <option value="">اختر الاسم</option>
            </select><br>
        </label>
        <label>شرح الاستفسار: <input type="text" id="inquiryDetails"></label>
        <label>تاريخ الاستفسار: <input type="date" id="inquiryDate"></label><br>
        <label>اسم الموظف: <input type="text" id="employeeName"></label>
    </div>

    <div id="complaintSection" class="hidden">
        <label>نوع الشكوى:
            <select id="complaintType" onchange="updateComplaintNames()">
                <option value="">اختر نوع الشكوى</option>
                <option value="شكوى عامة">شكوى عامة</option>
                <option value="شكوى خاصة">شكوى خاصة</option>
            </select>
        </label>
        <label>اسم الشكوى:
            <select id="complaintName">
                <option value="">اختر الاسم</option>
            </select><br>
        </label>
        <label>وصف الشكوى: <input type="text" id="complaintDetails"></label>
        <label>تاريخ الشكوى: <input type="date" id="complaintDate"></label><br>
        <label>اسم الموظف: <input type="text" id="employeeNameComplaint"></label>
    </div>

    <div class="fixed-buttons">
        <button onclick="saveData()">حفظ</button>
        <button onclick="searchClient()">بحث</button>
        <button onclick="deleteClient()">حذف</button>
        <button onclick="clearFields()">إضافة</button>
    </div>
    
    <div class="fixed-buttons">
        <button onclick="showTable()">عرض الجدول</button>
        <button onclick="exportToExcel()">استخراج الجدول</button>
        <button onclick="importFromExcel()">إدخال ملف</button>
        <button onclick="syncData()">مزامنة البيانات</button>
    </div>

    <h3>فلتر البيانات</h3>
    <label>بحث بالاسم: <input type="text" id="filterName" oninput="filterTable()"></label>
    <label>بحث بالتاريخ: <input type="date" id="filterDate" oninput="filterTable()"></label>
    <label>بحث برقم الهاتف: 
        <input type="text" id="filterPhone">
        <button onclick="filterByPhone()">بحث</button>
    </label>

    <table id="dataTable" class="hidden">
        <thead>
            <tr>
                <th>اسم العميل</th><th>رقم الهاتف</th><th>رقم آخر</th><th>المحافظة</th><th>المنطقة</th>
                <th>نوع الاستفسار</th><th>اسم الاستفسار</th><th>شرح الاستفسار</th><th>تاريخ الاستفسار</th><th>اسم الموظف</th>
                <th>نوع الشكوى</th><th>اسم الشكوى</th><th>وصف الشكوى</th><th>تاريخ الشكوى</th><th>اسم الموظف</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <h3 id="inquiriesHeader" class="hidden">الاستفسارات الخاصة بالعميل</h3>
    <table id="inquiriesTable" class="hidden">
        <thead>
            <tr>
                <th>نوع الاستفسار</th><th>اسم الاستفسار</th><th>شرح الاستفسار</th><th>تاريخ الاستفسار</th><th>اسم الموظف</th>
            </tr>
        </thead>
        <tbody id="inquiriesBody"></tbody>
    </table>

    <h3 id="complaintsHeader" class="hidden">الشكاوى الخاصة بالعميل</h3>
    <table id="complaintsTable" class="hidden">
        <thead>
            <tr>
                <th>نوع الشكوى</th><th>اسم الشكوى</th><th>وصف الشكوى</th><th>تاريخ الشكوى</th><th>اسم الموظف</th>
            </tr>
        </thead>
        <tbody id="complaintsBody"></tbody>
    </table>

    <script>
        // متغيرات التطبيق
        let clients = [];
        let isOnline = navigator.onLine;
        
        // متابعة حالة الاتصال
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        
        // تحميل البيانات عند بدء التشغيل
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            updateConnectionStatus();
        });
        
        // وظائف إدارة الاتصال
        function updateConnectionStatus() {
            isOnline = navigator.onLine;
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = isOnline 
                ? 'متصل بالإنترنت - البيانات متزامنة' 
                : 'غير متصل بالإنترنت - العمل في الوضع المحلي';
            statusElement.className = isOnline ? 'sync-status online' : 'sync-status offline';
        }
        
        // وظائف إدارة البيانات
        async function loadData() {
            updateConnectionStatus('جاري تحميل البيانات...', 'syncing');
            
            try {
                // محاولة جلب البيانات من Firebase إذا كان متصلاً
                if (isOnline) {
                    const firebaseClients = await window.firebaseFunctions.getAllClients();
                    clients = Object.values(firebaseClients);
                    
                    // حفظ نسخة محلية من البيانات
                    localStorage.setItem('clients', JSON.stringify(clients));
                    updateConnectionStatus('تم تحميل البيانات من السحابة', 'online');
                } else {
                    // جلب البيانات من التخزين المحلي إذا لم يكن متصلاً
                    const localData = localStorage.getItem('clients');
                    clients = localData ? JSON.parse(localData) : [];
                    updateConnectionStatus('تم تحميل البيانات المحلية', 'offline');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                const localData = localStorage.getItem('clients');
                clients = localData ? JSON.parse(localData) : [];
                updateConnectionStatus('تم تحميل البيانات المحلية فقط', 'offline');
            }
        }
        
        async function saveData() {
            // جمع البيانات من النموذج
            const clientData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                otherPhone: document.getElementById('otherPhone').value,
                governorate: document.getElementById('governorate').value,
                region: document.getElementById('region').value,
                inquiryType: document.getElementById('inquiryType').value,
                inquiryName: document.getElementById('inquiryName').value,
                inquiryDetails: document.getElementById('inquiryDetails').value,
                inquiryDate: document.getElementById('inquiryDate').value,
                employeeName: document.getElementById('employeeName').value,
                complaintType: document.getElementById('complaintType').value,
                complaintName: document.getElementById('complaintName').value,
                complaintDetails: document.getElementById('complaintDetails').value,
                complaintDate: document.getElementById('complaintDate').value,
                employeeNameComplaint: document.getElementById('employeeNameComplaint').value,
                lastUpdated: new Date().toISOString()
            };
            
            // التحقق من البيانات المطلوبة
            if (!clientData.name || !clientData.phone) {
                alert('الرجاء إدخال اسم العميل ورقم الهاتف على الأقل');
                return;
            }
            
            updateConnectionStatus('جاري حفظ البيانات...', 'syncing');
            
            try {
                // حفظ في Firebase إذا كان متصلاً
                if (isOnline) {
                    await window.firebaseFunctions.saveData(clientData);
                }
                
                // حفظ في التخزين المحلي
                const localClients = JSON.parse(localStorage.getItem('clients') || '[]');
                const existingIndex = localClients.findIndex(c => c.phone === clientData.phone);
                
                if (existingIndex >= 0) {
                    localClients[existingIndex] = clientData; // تحديث إذا موجود
                } else {
                    localClients.push(clientData); // إضافة إذا جديد
                }
                
                localStorage.setItem('clients', JSON.stringify(localClients));
                clients = localClients;
                
                alert('تم حفظ البيانات بنجاح!');
                updateConnectionStatus();
                clearFields();
            } catch (error) {
                console.error('Error saving data:', error);
                alert('حدث خطأ أثناء حفظ البيانات: ' + error.message);
                updateConnectionStatus();
            }
        }
        
        async function searchClient() {
            const phone = prompt('ادخل رقم الهاتف للبحث:');
            if (!phone) return;
            
            updateConnectionStatus('جاري البحث...', 'syncing');
            
            try {
                let client = null;
                
                // البحث في Firebase أولاً إذا كان متصلاً
                if (isOnline) {
                    client = await window.firebaseFunctions.getClient(phone);
                }
                
                // إذا لم يجده في Firebase، يبحث في التخزين المحلي
                if (!client) {
                    const localClients = JSON.parse(localStorage.getItem('clients') || '[]');
                    client = localClients.find(c => c.phone === phone);
                }
                
                if (client) {
                    displayClient(client);
                    
                    // عرض الاستفسارات والشكاوى الخاصة بهذا العميل
                    displayClientRecords(client.phone);
                } else {
                    alert('لا يوجد عميل بهذا الرقم');
                }
            } catch (error) {
                console.error('Error searching client:', error);
                alert('حدث خطأ أثناء البحث: ' + error.message);
            } finally {
                updateConnectionStatus();
            }
        }
        
        function displayClient(client) {
            document.getElementById('name').value = client.name || '';
            document.getElementById('phone').value = client.phone || '';
            document.getElementById('otherPhone').value = client.otherPhone || '';
            document.getElementById('governorate').value = client.governorate || '';
            updateRegions();
            setTimeout(() => {
                document.getElementById('region').value = client.region || '';
            }, 100);
            
            // تعبئة حقول الاستفسار إذا كانت موجودة
            if (client.inquiryType) {
                document.getElementById('inquiryType').value = client.inquiryType || '';
                updateInquiryNames();
                setTimeout(() => {
                    document.getElementById('inquiryName').value = client.inquiryName || '';
                }, 100);
                document.getElementById('inquiryDetails').value = client.inquiryDetails || '';
                document.getElementById('inquiryDate').value = client.inquiryDate || '';
                document.getElementById('employeeName').value = client.employeeName || '';
            }
            
            // تعبئة حقول الشكوى إذا كانت موجودة
            if (client.complaintType) {
                document.getElementById('complaintType').value = client.complaintType || '';
                updateComplaintNames();
                setTimeout(() => {
                    document.getElementById('complaintName').value = client.complaintName || '';
                }, 100);
                document.getElementById('complaintDetails').value = client.complaintDetails || '';
                document.getElementById('complaintDate').value = client.complaintDate || '';
                document.getElementById('employeeNameComplaint').value = client.employeeNameComplaint || '';
            }
        }
        
        function displayClientRecords(phone) {
            const localClients = JSON.parse(localStorage.getItem('clients') || []);
            const clientRecords = localClients.filter(c => c.phone === phone);
            
            // عرض الاستفسارات
            const inquiriesBody = document.getElementById('inquiriesBody');
            inquiriesBody.innerHTML = '';
            clientRecords
                .filter(c => c.inquiryType)
                .forEach(c => {
                    inquiriesBody.innerHTML += `
                        <tr>
                            <td>${c.inquiryType}</td>
                            <td>${c.inquiryName}</td>
                            <td>${c.inquiryDetails}</td>
                            <td>${c.inquiryDate}</td>
                            <td>${c.employeeName}</td>
                        </tr>`;
                });
            
            // عرض الشكاوى
            const complaintsBody = document.getElementById('complaintsBody');
            complaintsBody.innerHTML = '';
            clientRecords
                .filter(c => c.complaintType)
                .forEach(c => {
                    complaintsBody.innerHTML += `
                        <tr>
                            <td>${c.complaintType}</td>
                            <td>${c.complaintName}</td>
                            <td>${c.complaintDetails}</td>
                            <td>${c.complaintDate}</td>
                            <td>${c.employeeNameComplaint}</td>
                        </tr>`;
                });
            
            // إظهار الجداول إذا كانت هناك بيانات
            if (inquiriesBody.innerHTML) {
                document.getElementById('inquiriesTable').classList.remove('hidden');
                document.getElementById('inquiriesHeader').classList.remove('hidden');
            }
            if (complaintsBody.innerHTML) {
                document.getElementById('complaintsTable').classList.remove('hidden');
                document.getElementById('complaintsHeader').classList.remove('hidden');
            }
        }
        
        async function deleteClient() {
            const phone = prompt('ادخل رقم الهاتف للحذف:');
            if (!phone) return;
            
            updateConnectionStatus('جاري حذف البيانات...', 'syncing');
            
            try {
                // حذف من Firebase إذا كان متصلاً
                if (isOnline) {
                    await window.firebaseFunctions.deleteClient(phone);
                }
                
                // حذف من التخزين المحلي
                const localClients = JSON.parse(localStorage.getItem('clients') || '[]');
                const updatedClients = localClients.filter(c => c.phone !== phone);
                
                localStorage.setItem('clients', JSON.stringify(updatedClients));
                clients = updatedClients;
                
                alert('تم حذف العميل بنجاح!');
                clearFields();
            } catch (error) {
                console.error('Error deleting client:', error);
                alert('حدث خطأ أثناء الحذف: ' + error.message);
            } finally {
                updateConnectionStatus();
            }
        }
        
        async function syncData() {
            updateConnectionStatus('جاري مزامنة البيانات...', 'syncing');
            
            try {
                // جلب البيانات من Firebase
                const firebaseClients = await window.firebaseFunctions.getAllClients();
                
                // جلب البيانات المحلية
                const localClients = JSON.parse(localStorage.getItem('clients') || '[]');
                
                // دمج البيانات (الأحدث يحل محل الأقدم)
                const mergedClients = [...localClients];
                
                Object.values(firebaseClients).forEach(fbClient => {
                    const existingIndex = mergedClients.findIndex(lc => lc.phone === fbClient.phone);
                    if (existingIndex >= 0) {
                        // استبدال إذا كان بيانات Firebase أحدث
                        if (new Date(fbClient.lastUpdated) > new Date(mergedClients[existingIndex].lastUpdated)) {
                            mergedClients[existingIndex] = fbClient;
                        }
                    } else {
                        mergedClients.push(fbClient);
                    }
                });
                
                // حفظ البيانات المدمجة في Firebase
                for (const client of mergedClients) {
                    await window.firebaseFunctions.saveData(client);
                }
                
                // حفظ البيانات المدمجة محلياً
                localStorage.setItem('clients', JSON.stringify(mergedClients));
                clients = mergedClients;
                
                alert('تمت مزامنة البيانات بنجاح!');
            } catch (error) {
                console.error('Error syncing data:', error);
                alert('فشلت المزامنة: ' + error.message);
            } finally {
                updateConnectionStatus();
            }
        }
        
        // وظائف العرض والتصفية
        function showTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            clients.forEach(client => {
                tableBody.innerHTML += `
                <tr>
                    <td>${client.name || ''}</td>
                    <td>${client.phone || ''}</td>
                    <td>${client.otherPhone || ''}</td>
                    <td>${client.governorate || ''}</td>
                    <td>${client.region || ''}</td>
                    <td>${client.inquiryType || ''}</td>
                    <td>${client.inquiryName || ''}</td>
                    <td>${client.inquiryDetails || ''}</td>
                    <td>${client.inquiryDate || ''}</td>
                    <td>${client.employeeName || ''}</td>
                    <td>${client.complaintType || ''}</td>
                    <td>${client.complaintName || ''}</td>
                    <td>${client.complaintDetails || ''}</td>
                    <td>${client.complaintDate || ''}</td>
                    <td>${client.employeeNameComplaint || ''}</td>
                </tr>`;
            });
            
            document.getElementById('dataTable').classList.remove('hidden');
        }
        
        function filterTable() {
            const nameFilter = document.getElementById('filterName').value.toLowerCase();
            const dateFilter = document.getElementById('filterDate').value;
            const phoneFilter = document.getElementById('filterPhone').value.toLowerCase();
            
            const filteredClients = clients.filter(client => {
                const matchesName = client.name && client.name.toLowerCase().includes(nameFilter);
                const matchesDate = !dateFilter || 
                    (client.inquiryDate && client.inquiryDate.includes(dateFilter)) || 
                    (client.complaintDate && client.complaintDate.includes(dateFilter));
                const matchesPhone = !phoneFilter || 
                    (client.phone && client.phone.toLowerCase().includes(phoneFilter)) || 
                    (client.otherPhone && client.otherPhone.toLowerCase().includes(phoneFilter));
                
                return matchesName && matchesDate && matchesPhone;
            });
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            filteredClients.forEach(client => {
                tableBody.innerHTML += `
                <tr>
                    <td>${client.name || ''}</td>
                    <td>${client.phone || ''}</td>
                    <td>${client.otherPhone || ''}</td>
                    <td>${client.governorate || ''}</td>
                    <td>${client.region || ''}</td>
                    <td>${client.inquiryType || ''}</td>
                    <td>${client.inquiryName || ''}</td>
                    <td>${client.inquiryDetails || ''}</td>
                    <td>${client.inquiryDate || ''}</td>
                    <td>${client.employeeName || ''}</td>
                    <td>${client.complaintType || ''}</td>
                    <td>${client.complaintName || ''}</td>
                    <td>${client.complaintDetails || ''}</td>
                    <td>${client.complaintDate || ''}</td>
                    <td>${client.employeeNameComplaint || ''}</td>
                </tr>`;
            });
        }
        
        function filterByPhone() {
            const phone = document.getElementById('filterPhone').value.toLowerCase();
            if (!phone) {
                showTable();
                return;
            }
            
            const filteredClients = clients.filter(client => 
                (client.phone && client.phone.toLowerCase().includes(phone)) || 
                (client.otherPhone && client.otherPhone.toLowerCase().includes(phone))
            );
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            filteredClients.forEach(client => {
                tableBody.innerHTML += `
                <tr>
                    <td>${client.name || ''}</td>
                    <td>${client.phone || ''}</td>
                    <td>${client.otherPhone || ''}</td>
                    <td>${client.governorate || ''}</td>
                    <td>${client.region || ''}</td>
                    <td>${client.inquiryType || ''}</td>
                    <td>${client.inquiryName || ''}</td>
                    <td>${client.inquiryDetails || ''}</td>
                    <td>${client.inquiryDate || ''}</td>
                    <td>${client.employeeName || ''}</td>
                    <td>${client.complaintType || ''}</td>
                    <td>${client.complaintName || ''}</td>
                    <td>${client.complaintDetails || ''}</td>
                    <td>${client.complaintDate || ''}</td>
                    <td>${client.employeeNameComplaint || ''}</td>
                </tr>`;
            });
        }
        
        // وظائف المساعدة
        function clearFields() {
            document.getElementById('name').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('otherPhone').value = '';
            document.getElementById('governorate').value = '';
            document.getElementById('region').value = '';
            document.getElementById('inquiryType').value = '';
            document.getElementById('inquiryName').innerHTML = '<option value="">اختر الاسم</option>';
            document.getElementById('inquiryDetails').value = '';
            document.getElementById('inquiryDate').value = '';
            document.getElementById('employeeName').value = '';
            document.getElementById('complaintType').value = '';
            document.getElementById('complaintName').innerHTML = '<option value="">اختر الاسم</option>';
            document.getElementById('complaintDetails').value = '';
            document.getElementById('complaintDate').value = '';
            document.getElementById('employeeNameComplaint').value = '';
            
            document.getElementById('inquiriesTable').classList.add('hidden');
            document.getElementById('inquiriesHeader').classList.add('hidden');
            document.getElementById('complaintsTable').classList.add('hidden');
            document.getElementById('complaintsHeader').classList.add('hidden');
        }
        
        function toggleInquiry() {
            document.getElementById('inquirySection').classList.remove('hidden');
            document.getElementById('complaintSection').classList.add('hidden');
        }
        
        function toggleComplaint() {
            document.getElementById('complaintSection').classList.remove('hidden');
            document.getElementById('inquirySection').classList.add('hidden');
        }
        
        function updateRegions() {
            const gov = document.getElementById('governorate').value;
            const regionSelect = document.getElementById('region');
            regionSelect.innerHTML = '<option value="">اختر المنطقة</option>';
            
            const regions = {
                'القاهرة': ['مدينة نصر', 'المعادي', 'حلوان'],
                'الجيزة': ['الدقي', 'الهرم', 'فيصل']
            };
            
            if (regions[gov]) {
                regions[gov].forEach(region => {
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                });
            }
        }
        
        function updateInquiryNames() {
            const type = document.getElementById('inquiryType').value;
            const nameSelect = document.getElementById('inquiryName');
            nameSelect.innerHTML = '<option value="">اختر الاسم</option>';
            
            const names = {
                'استفسار عام': ['استفسار عام 1', 'استفسار عام 2'],
                'استفسار خاص': ['استفسار خاص 1', 'استفسار خاص 2']
            };
            
            if (names[type]) {
                names[type].forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    nameSelect.appendChild(option);
                });
            }
        }
        
        function updateComplaintNames() {
            const type = document.getElementById('complaintType').value;
            const nameSelect = document.getElementById('complaintName');
            nameSelect.innerHTML = '<option value="">اختر الاسم</option>';
            
            const names = {
                'شكوى عامة': ['شكوى عامة 1', 'شكوى عامة 2'],
                'شكوى خاصة': ['شكوى خاصة 1', 'شكوى خاصة 2']
            };
            
            if (names[type]) {
                names[type].forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    nameSelect.appendChild(option);
                });
            }
        }
        
        // وظائف الاستيراد والتصدير
        function exportToExcel() {
            if (clients.length === 0) {
                alert("لا توجد بيانات لاستخراجها.");
                return;
            }

            const worksheetData = [
                ["اسم العميل", "رقم الهاتف", "رقم آخر", "المحافظة", "المنطقة",
                 "نوع الاستفسار", "اسم الاستفسار", "شرح الاستفسار", "تاريخ الاستفسار", "اسم الموظف",
                 "نوع الشكوى", "اسم الشكوى", "وصف الشكوى", "تاريخ الشكوى", "اسم الموظف", "آخر تحديث"]
            ];

            clients.forEach(c => {
                worksheetData.push([
                    c.name, c.phone, c.otherPhone, c.governorate, c.region,
                    c.inquiryType, c.inquiryName, c.inquiryDetails, c.inquiryDate, c.employeeName,
                    c.complaintType, c.complaintName, c.complaintDetails, c.complaintDate, c.employeeNameComplaint,
                    c.lastUpdated
                ]);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "العملاء");

            const excelFile = XLSX.write(workbook, { bookType: "xlsx", type: "binary" });

            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }

            const blob = new Blob([s2ab(excelFile)], { type: "application/octet-stream" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "بيانات_العملاء.xlsx";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert("✅ تم تنزيل الملف بنجاح إلى التنزيلات.");
        }
        
        function importFromExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        if (jsonData.length === 0) {
                            alert("الملف لا يحتوي على بيانات صالحة");
                            return;
                        }
                        
                        // تجاهل الصف الأول إذا كان يحتوي على العناوين
                        const startIndex = jsonData[0]['اسم العميل'] ? 0 : 1;
                        
                        updateConnectionStatus('جاري استيراد البيانات...', 'syncing');
                        
                        for (let i = startIndex; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            const clientData = {
                                name: row['اسم العميل'],
                                phone: row['رقم الهاتف'],
                                otherPhone: row['رقم آخر'],
                                governorate: row['المحافظة'],
                                region: row['المنطقة'],
                                inquiryType: row['نوع الاستفسار'],
                                inquiryName: row['اسم الاستفسار'],
                                inquiryDetails: row['شرح الاستفسار'],
                                inquiryDate: row['تاريخ الاستفسار'],
                                employeeName: row['اسم الموظف'],
                                complaintType: row['نوع الشكوى'],
                                complaintName: row['اسم الشكوى'],
                                complaintDetails: row['وصف الشكوى'],
                                complaintDate: row['تاريخ الشكوى'],
                                employeeNameComplaint: row['اسم الموظف'],
                                lastUpdated: new Date().toISOString()
                            };
                            
                            // حفظ البيانات
                            if (clientData.phone) {
                                if (isOnline) {
                                    await window.firebaseFunctions.saveData(clientData);
                                }
                                
                                const localClients = JSON.parse(localStorage.getItem('clients') || '[]');
                                const existingIndex = localClients.findIndex(c => c.phone === clientData.phone);
                                
                                if (existingIndex >= 0) {
                                    localClients[existingIndex] = clientData;
                                } else {
                                    localClients.push(clientData);
                                }
                                
                                localStorage.setItem('clients', JSON.stringify(localClients));
                            }
                        }
                        
                        clients = JSON.parse(localStorage.getItem('clients') || '[]');
                        alert(`تم استيراد ${jsonData.length - startIndex} سجل بنجاح!`);
                    } catch (error) {
                        console.error('Error importing data:', error);
                        alert('حدث خطأ أثناء استيراد البيانات: ' + error.message);
                    } finally {
                        updateConnectionStatus();
                    }
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            input.click();
        }
    </script>
</body>
</html>
